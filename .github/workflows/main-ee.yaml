name: GraalVM Jibber Github Actions Pipeline (EE)
on: [push, pull_request]
jobs:
  build:
    name: GraalVM Jibber on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v2

      - uses: graalvm/setup-graalvm@v1
        with:
          version: 'latest'
          gds-token: ${{ secrets.GDS_TOKEN }}
          java-version: '17'
          components: 'native-image'
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Test Java Code
        run: |
          ./mvnw --no-transfer-progress clean test
          ./mvnw --no-transfer-progress -Pnative package 

      - name: Archive production artifacts
        uses: actions/upload-artifact@v3
        with:
          name: dist
          path: |
            target/jibber
            Dockerfiles/Dockerfile.native
          retention-days: 1

  push_container:
    name: Push Container to OCIR
    needs: [build]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
    if: github.ref == 'refs/heads/main'
    env:
      OCI_CLI_USER: ${{ secrets.OCI_USER_OCID }}
      OCI_CLI_TENANCY: ${{ secrets.OCI_TENANCY_OCID }}
      OCI_CLI_FINGERPRINT: ${{ secrets.OCI_FINGERPRINT }}
      OCI_CLI_KEY_CONTENT: ${{ secrets.OCI_KEY_FILE }}
      OCI_CLI_REGION: ${{ secrets.OCI_REGION }}
      OCI_CLI_COMPARTMENT: ${{ secrets.OCI_COMPARTMENT_OCID }}
    steps:
      - name: Get or create an OCIR Repository
        uses: oracle-actions/get-ocir-repository@v1.1
        id: get-ocir-repository
        with:
          name: oraclelinux
          compartment: ${{ secrets.OCI_COMPARTMENT_OCID }}

      - name: Log into OCIR
        uses: oracle-actions/login-ocir@v1.1
        id: login-ocir
        with:
          auth_token: ${{ secrets.OCI_AUTH_TOKEN }}

      - name: Download a single artifact
        uses: actions/download-artifact@v3
        with:
          name: dist

      - name: Tag and push a container image
        id: tag-and-push-image
        run: |
          docker pull oraclelinux:8-slim
          docker build -t ${{ steps.get-ocir-repository.outputs.repository }}/jibber:native.latest -f Dockerfiles/Dockerfile.native .
          docker push "${{ steps.get-ocir-repository.outputs.repo_path }}/jibber:native.latest"